<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Stock Tracker Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Custom styles to mimic the gradient background and ensure full height */
        body {
            background: linear-gradient(to bottom, #000000, #021b21, #000000);
            color: white;
            min-height: 100vh;
            font-family: sans-serif;
        }
        /* Custom scrollbar style for better look on dark theme */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #06b6d4; /* cyan-500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937; /* gray-800 */
        }
        
        /* The chart container needs a specific height to render Chart.js correctly */
        #stockChartContainer {
            height: 380px;
            max-width: 450px;
            margin: auto;
        }

        /* Chart.js overrides to ensure text is white/dark for contrast */
        .chartjs-render-monitor {
            color: white;
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8 font-sans text-white">
        <div class="max-w-6xl mx-auto space-y-6">

            <div class="bg-gray-900/70 backdrop-blur-md border border-gray-700/50 rounded-2xl p-6 shadow-2xl shadow-cyan-500/10 flex flex-col md:flex-row items-center justify-between">
                <div class="text-center md:text-left flex-1">
                    <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Stock Tracker</h1>
                    <p class="text-gray-300 text-sm sm:text-base">Track Empty & Filled Stock with Reports</p>
                </div>
                <a href="1_Login.html" class="mt-4 md:mt-0 bg-cyan-400 text-black px-5 py-2 rounded-lg text-lg font-semibold hover:bg-cyan-300 transition shadow-lg shadow-cyan-500/30">
                    Home
                </a>
            </div>

            <div class="bg-gray-900/70 backdrop-blur-md border border-gray-700/50 rounded-2xl p-6 shadow-2xl shadow-cyan-500/10">
                <h2 class="text-2xl font-semibold mb-4 text-center text-white">Stock Status Breakdown</h2>
                <div id="stockChartContainer">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-900/70 backdrop-blur-md border border-gray-700/50 rounded-2xl p-6 shadow-2xl shadow-cyan-500/10">
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <input
                        type="text"
                        id="item-name"
                        placeholder="Enter item name"
                        class="border border-gray-600 rounded-lg p-3 flex-grow bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400"
                    />
                    <select
                        id="item-status"
                        class="border border-gray-600 rounded-lg p-3 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
                    >
                        <option value="Filled">Filled</option>
                        <option value="Empty">Empty</option>
                    </select>
                    <button
                        id="add-item-btn"
                        class="bg-cyan-400 text-black px-6 py-3 rounded-lg font-semibold hover:bg-cyan-300 transition shadow-lg shadow-cyan-500/30"
                    >
                        Add Item
                    </button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <button onclick="generateReport('day')" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                        Daily Report
                    </button>
                    <button onclick="generateReport('week')" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                        Weekly Report
                    </button>
                    <button onclick="generateReport('month')" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                        Monthly Report
                    </button>
                    <button onclick="generateReport('year')" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                        Yearly Report
                    </button>
                </div>

                <div id="items" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    <p id="no-items-message" class="text-gray-400 text-center italic">No items added yet.</p>
                </div>
            </div>

            <div class="bg-gray-900/70 backdrop-blur-md border border-gray-700/50 rounded-2xl p-6 shadow-2xl shadow-cyan-500/10">
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">ðŸ“‚ Saved Reports</h2>
                <div id="savedReports" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    <p id="no-reports-message" class="text-gray-400 text-center italic">No reports saved yet.</p>
                </div>
            </div>
        </div>

        <div id="emptyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
            <div class="bg-gray-900 border border-cyan-400/50 rounded-2xl shadow-2xl shadow-cyan-500/20 p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">Enter Stock Details</h2>
                <input
                    type="number"
                    id="empty-qty"
                    placeholder="Enter quantity (e.g. 10)"
                    class="w-full mb-3 border border-gray-600 rounded-lg p-3 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400"
                />
                <input
                    type="text"
                    id="empty-desc"
                    placeholder="Enter description (e.g. 10 packets)"
                    class="w-full mb-4 border border-gray-600 rounded-lg p-3 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400"
                />
                <div class="flex justify-end gap-4">
                    <button id="closeEmptyModalBtn" class="bg-gray-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-gray-500 transition">Cancel</button>
                    <button id="saveEmptyDetailsBtn" class="bg-cyan-400 text-black px-5 py-2 rounded-lg font-semibold hover:bg-cyan-300 transition">Save</button>
                </div>
            </div>
        </div>

        <div id="reportModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
            <div class="bg-gray-900 border border-cyan-400/50 rounded-2xl shadow-2xl shadow-cyan-500/20 p-6 w-full max-w-lg">
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">Report</h2>
                <div
                    id="reportContent"
                    class="text-white text-base space-y-1 bg-gray-800 p-4 rounded-lg border border-gray-700 max-h-80 overflow-y-auto custom-scrollbar whitespace-pre-wrap"
                >
                    </div>
                <div class="flex justify-between gap-4 mt-6">
                    <button id="closeReportModalBtn" class="bg-gray-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-gray-500 transition">Close</button>
                    <button id="downloadPdfBtn" class="bg-green-500 text-black px-5 py-2 rounded-lg font-semibold hover:bg-green-400 transition">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use window.jspdf as imported via CDN
        const jsPDF = window.jspdf.jsPDF;
        
        // --- STATE & DOM ELEMENTS ---
        let stockState = JSON.parse(localStorage.getItem("stockState") || '[]');
        let savedReports = JSON.parse(localStorage.getItem("savedReports") || '[]');
        let tempItem = null;
        let currentReportText = '';

        const itemNameInput = document.getElementById('item-name');
        const itemStatusSelect = document.getElementById('item-status');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items');
        const savedReportsContainer = document.getElementById('savedReports');
        const noItemsMessage = document.getElementById('no-items-message');
        const noReportsMessage = document.getElementById('no-reports-message');
        
        // Modals
        const emptyModal = document.getElementById('emptyModal');
        const reportModal = document.getElementById('reportModal');
        const emptyQtyInput = document.getElementById('empty-qty');
        const emptyDescInput = document.getElementById('empty-desc');
        const saveEmptyDetailsBtn = document.getElementById('saveEmptyDetailsBtn');
        const closeEmptyModalBtn = document.getElementById('closeEmptyModalBtn');
        const reportContentDiv = document.getElementById('reportContent');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        
        let stockChartInstance = null; // To hold the Chart.js instance

        // --- PERSISTENCE ---
        const saveState = () => {
            localStorage.setItem("stockState", JSON.stringify(stockState));
            renderItems();
            renderChart();
        };

        const saveReports = () => {
            localStorage.setItem("savedReports", JSON.stringify(savedReports));
            renderSavedReports();
        };
        
        // --- ITEM LOGIC ---
        const addItem = () => {
            const name = itemNameInput.value.trim();
            const status = itemStatusSelect.value;
            if (!name) return;

            const item = { name: name, status: status, date: new Date().toISOString() };

            if (status === "Empty") {
                tempItem = item;
                openEmptyModal();
            } else {
                stockState.push(item);
                saveState();
                itemNameInput.value = "";
            }
        };

        const removeItem = (indexToRemove) => {
            stockState = stockState.filter((_, index) => index !== indexToRemove);
            saveState();
        };

        // --- MODAL LOGIC ---
        const openEmptyModal = () => {
            emptyModal.classList.remove('hidden');
        };

        const closeEmptyModal = () => {
            emptyModal.classList.add('hidden');
            tempItem = null;
            emptyQtyInput.value = '';
            emptyDescInput.value = '';
            itemNameInput.value = ''; // Clear main input on cancel/save
        };

        const saveEmptyDetails = () => {
            const qty = parseInt(emptyQtyInput.value, 10);
            const desc = emptyDescInput.value.trim();

            if (!qty || qty <= 0 || !tempItem) return;

            const itemWithDetails = {
                ...tempItem,
                requiredStock: qty,
                description: desc || `${qty} units`,
            };

            stockState.push(itemWithDetails);
            saveState();
            closeEmptyModal();
        };

        const openReportModal = () => {
            reportModal.classList.remove('hidden');
        };

        const closeReportModal = () => {
            reportModal.classList.add('hidden');
        };

        // --- REPORT LOGIC ---
        const getReportData = (period) => {
            const now = new Date();
            const getFilterDate = () => {
                let date = new Date(now);
                if (period === "week") date.setDate(now.getDate() - 7);
                else if (period === "month") date.setMonth(now.getMonth() - 1);
                else if (period === "year") date.setFullYear(now.getFullYear() - 1); 
                return date;
            };
            
            const filterDate = getFilterDate();

            return stockState.filter(item => {
                const itemDate = new Date(item.date);
                if (period === "day") return itemDate.toDateString() === now.toDateString();
                // For week, month, year, filter by items added after the filter date
                return itemDate >= filterDate;
            });
        };

        const generateReport = (period) => {
            const reportData = getReportData(period);
            const filled = reportData.filter(i => i.status === "Filled").length;
            const emptyItems = reportData.filter(i => i.status === "Empty");
            const totalNeeded = emptyItems.reduce((a, b) => a + (b.requiredStock || 0), 0);
            const dateStr = new Date().toLocaleString();

            let reportText = 
`Stock Report
Date: ${dateStr}
Period: ${period.toUpperCase()}

Summary:
Filled Items: ${filled}
Empty Items: ${emptyItems.length}
Total Stock Needed: ${totalNeeded}

Empty Items Detail:
${emptyItems.length === 0 ? "No empty items." : emptyItems.map(it => `- ${it.name}: Needs ${it.requiredStock || 'N/A'} (${it.description || 'No description'})`).join('\n')}`;

            currentReportText = reportText;
            
            // Format for display in the modal
            reportContentDiv.textContent = reportText;

            // Save to history
            savedReports.unshift({ text: reportText, date: dateStr }); // Add to beginning
            saveReports(); 
            openReportModal();
            
            // Update the download button for the new report
            downloadPdfBtn.onclick = () => downloadPDF(reportText, dateStr);
        };

        const downloadPDF = (text, date) => {
            const doc = new jsPDF();
            doc.setFontSize(12);
            doc.text("Stock Report - " + (date || new Date().toLocaleString()), 10, 10);

            // Split text into lines for PDF
            const lines = doc.splitTextToSize(text, 180);
            doc.text(lines, 10, 20);

            doc.save("Stock_Report.pdf");
        };

        const openSavedReport = (report) => {
            currentReportText = report.text;
            reportContentDiv.textContent = report.text;
            // Update the download button for the specific saved report
            downloadPdfBtn.onclick = () => downloadPDF(report.text, report.date); 
            openReportModal();
        };

        // --- RENDERING ---

        const renderItems = () => {
            itemsContainer.innerHTML = '';
            if (stockState.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
                stockState.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "flex justify-between items-center bg-gray-800/50 border border-gray-700 p-4 rounded-lg";
                    
                    const statusClass = item.status === 'Empty' ? 'text-pink-400' : 'text-cyan-400';
                    let detailsSpan = '';
                    if (item.status === 'Empty' && item.requiredStock) {
                        detailsSpan = `<span class="text-gray-400 text-sm"> (Needs: ${item.requiredStock} ${item.description})</span>`;
                    }

                    itemDiv.innerHTML = `
                        <span class="text-gray-200">
                            ${item.name} -
                            <span class="${statusClass}"> ${item.status}</span>
                            ${detailsSpan}
                        </span>
                        <button class="text-red-500 hover:text-red-400 font-bold text-2xl remove-btn" data-index="${index}">&times;</button>
                    `;
                    itemsContainer.appendChild(itemDiv);
                });
                
                // Attach event listeners to the new remove buttons
                itemsContainer.querySelectorAll('.remove-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index, 10);
                        removeItem(index);
                    });
                });
            }
        };

        const renderSavedReports = () => {
            savedReportsContainer.innerHTML = '';
            if (savedReports.length === 0) {
                noReportsMessage.classList.remove('hidden');
            } else {
                noReportsMessage.classList.add('hidden');
                savedReports.forEach((r, i) => {
                    const reportDiv = document.createElement('div');
                    reportDiv.className = "flex justify-between items-center bg-gray-800/50 border border-gray-700 p-4 rounded-lg";
                    reportDiv.innerHTML = `
                        <span class="text-gray-300">${r.date}</span>
                        <div class="space-x-3">
                            <button data-index="${i}" class="bg-cyan-400 text-black px-3 py-1 rounded-md text-sm font-medium hover:bg-cyan-300 transition view-report-btn">View</button>
                            <button data-text="${encodeURIComponent(r.text)}" data-date="${r.date}" class="bg-green-500 text-black px-3 py-1 rounded-md text-sm font-medium hover:bg-green-400 transition download-pdf-btn">Download</button>
                        </div>
                    `;
                    savedReportsContainer.appendChild(reportDiv);
                });

                // Attach event listeners
                savedReportsContainer.querySelectorAll('.view-report-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index, 10);
                        openSavedReport(savedReports[index]);
                    });
                });
                savedReportsContainer.querySelectorAll('.download-pdf-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const text = decodeURIComponent(e.target.dataset.text);
                        const date = e.target.dataset.date;
                        downloadPDF(text, date);
                    });
                });
            }
        };

        // --- CHARTING ---
        const renderChart = () => {
            const filled = stockState.filter(i => i.status === "Filled").length;
            const empty = stockState.filter(i => i.status === "Empty").length;
            const total = filled + empty;

            const chartData = {
                labels: ['Filled', 'Empty'],
                datasets: [{
                    data: [filled, empty],
                    backgroundColor: ['#22d3ee', '#ec4899'], // Cyan and Pink
                    hoverOffset: 4
                }]
            };

            const chartConfig = {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#FFFFFF' 
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };

            // Destroy existing chart instance before creating a new one
            if (stockChartInstance) {
                stockChartInstance.destroy();
            }

            // Create new chart instance
            const ctx = document.getElementById('stockChart').getContext('2d');
            stockChartInstance = new Chart(ctx, chartConfig);
        };

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderItems();
            renderSavedReports();
            renderChart();

            // Add Item Event
            addItemBtn.addEventListener('click', addItem);
            itemNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addItem();
            });

            // Empty Modal Events
            saveEmptyDetailsBtn.addEventListener('click', saveEmptyDetails);
            closeEmptyModalBtn.addEventListener('click', closeEmptyModal);

            // Report Modal Events
            closeReportModalBtn.addEventListener('click', closeReportModal);
            
            // Set default PDF download behavior (for new reports)
            downloadPdfBtn.addEventListener('click', () => downloadPDF(currentReportText));
        });
    </script>

</body>
</html>